# Textual modeling decisions for DSL

This README is aiming to deliver an overview of what we have done, both in words and graphs. Note that graphs are delivered later.

## 1. Checklist for deliverables:
- [x] Static configuration: Mapping between pedals and types of X-ray
- [x] Static configuration: Order of projections when using the selection pedal
- [x] Dynamic logic: Behavior of the selection pedal when other pedals are already pressed
- [x] Dynamic logic: Behavior for combinations of X-ray requests with the same dose
- [x] Dynamic logic: Behavior for combinations of X-ray requests with a different dose
- [x] Your grammar (Xtext file)
- [x] Relevant example instances of your grammar.
- [x] Add model validation for early feedback to users of your language.
- [x] Your code generator (Xtend files)
- [x] Generated code for some relevant example instances of your language.

## 2. DSL modeling language
This chapter introduce the grammar of the DSL modeling language for 3-pedal and 6-pedal systems. The rule 'SystemType' indicates the whole system which has two feature: configuration and logic standing for "static configuration" and "dynamic logic" respectivley.



'Configuration' has two types, Threepedals and SixPedals. For Threepedals, it only has three different pedals. In our design, pedal1 and pedal2 are used for low and high dose Xray in video mode. **Pedal3 can only be used for low dose Xray in image mode.** This is limited by its validation which will be introduced in next chapter. 

For Sixpedals, pedal1-3 are used for low dose Xray in any mode. Pedal4 is only used for projection selection. Pedal5 and pedal 6 are used for high dose Xray.

The rule 'Pedal' is used to describe each pedal. It has three features. 'DoseType' indicates which type of Xray is controlled by the pedal. 'Function' represents video or image modes. 'Projection' is an optional feature. For ThreePedals system, it is frontal as default which doesn't need to be set by users. But for SixPedals system, it needs to be set to pedal1-3 (this feature of pedal4-6 can also be set, but those pedals have preset functions and will not be affected by user settings)


The rule 'Logic' has three features. DIDB(Different Dose Behavior) indicates the logic should be applied when pedals of different doses are pressed. SPB(Selection Pedal Behavior) and SADB(Same Dose Behavior) are two optional features which are only needed to be set in SixPedals systems.

Each feature has two sub-features: HB(High behavior) and LB(Low behavior) which mean future behaviors when high or low dose xray is active. They both have two states: low/high_pressed_combine/ignore. For example, high_pressed_combin means if the next pressed high dose xray pedal will replace the previous state. Such as, when a pedal of low dose is pressed, a high dose pedal is pressed subsequently, high dose xray will replace low dose xray. Except that, high_pressed_ignore means the next pressed high dose xray pedal will be ignored.

## 3. Validation
Our validation mainly focuses on two aspects: correct usage of each pedal and proper priorities of different dose requests.

For ThreePedals system, we make sure pedal3 can only be used for low dose and image mode. For system logic, after high dose pedal is pressed, it can always replace the previous state.

For SixPedals system, we make sure pedal1-3 can only be used for low dose, pedal4 is only used for projection selections, pedal5 are only for high dose. For system logic, we make sure after high dose pedal is pressed, it can always replace the previous state. And also, when a high dose pedal is pressed, projection can not be changed.

## 4. Code Generation
The code generation is responsible to generate both the "Cargo.toml" file and the "main" file. **Note that only code for the three padels system requries to be generated.** First of all, the "Cargo.toml" file is generated. There is one thing that the user needs to be aware of is that in the line which says: name = "example" requires to be adjusted. The name should be matching the name of the project the user created.

It is recommended that the user type the following the code in the terminal to generate a new Rust project to run the code generated by this assignment:

```
cd Desktop/
cargo new example
```

After using the code above to create a new Rust project, then copy corresponding code into corresponding files, and then do:
```
cargo run
```

Back to the main topic, besides generating the.toml file, the .rs file is also generated. The part which requires most effort is the ActionLogic part, it needs to obey the rules which applies to the three padels system, which is:
1. While using low-dose streaming video, surgeons need to be able to temporarily switch to high-dose streaming video, without releasing the low-dose streaming video pedal.
2. While release a padel, and the other padels stepped on. The status of the machine is required to resume to the last state.
3. While switching among low-dose padels, the functionality always depends on the latest stepped pedal.

In this case, a technique which assigns each job a weighted value is thought of:
- Low-dose + Image: 1
- Low-dose + Video: 2
- High-dose + Video: 3

By keep track of the sum of the values of activated functions, which ones are pressed on could be tracked.

In addition, by keeping track of the last activated padel with extra variables in the Logic struct, all the information could be know. (**Please refer to our source code for more detial, they are well documented**)

## 5. Deliverables in figures
1. Part of our concrete syntax: ![](https://i.imgur.com/JGoa4Kj.jpg)

2. Example of our runtime instances defined: ![](https://i.imgur.com/l3ZnMC9.jpg)
3. 1/2 Code generator (considering files): ![](https://i.imgur.com/7TQxR2W.jpg)

4. 2/2 Code generator (considering detialed text): ![](https://i.imgur.com/nipvjW4.jpg)

5. Simulation of the generated code: ![](https://i.imgur.com/BAIAmTs.png)
![](https://i.imgur.com/RFiSUpe.png)
![](https://i.imgur.com/ZpK6clw.png)
![](https://i.imgur.com/J8LNHo5.png)
